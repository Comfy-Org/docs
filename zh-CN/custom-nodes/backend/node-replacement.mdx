---
title: "节点替换"
description: "注册节点替换以帮助用户从已弃用的节点迁移"
---

节点替换 API 允许自定义节点开发者定义从已弃用节点到新版本节点的迁移路径。当您更新或重命名节点时，用户可以自动升级其工作流。

## 注册替换

使用 `comfy_api.latest` 模块注册节点替换：

```python
from comfy_api.latest import io, ComfyAPI

api = ComfyAPI()

await api.node_replacement.register(
    io.NodeReplace(
        new_node_id="NewNodeClass",
        old_node_id="OldNodeClass",
        old_widget_ids=["old_input_name", "old_param"],
        input_mapping=[
            {"new_id": "new_input_name", "old_id": "old_input_name"},
            {"new_id": "new_param", "set_value": 512},
        ],
        output_mapping=[
            {"new_idx": 0, "old_idx": 0},
        ],
    )
)
```

## NodeReplace 参数

| 参数 | 类型 | 描述 |
|-----------|------|-------------|
| `new_node_id` | str | 替换节点的类名 |
| `old_node_id` | str | 已弃用节点的类名 |
| `old_widget_ids` | list[str] \| None | 将小部件 ID 绑定到其相对索引的有序列表 |
| `input_mapping` | list \| None | 如何将输入从旧节点映射到新节点 |
| `output_mapping` | list \| None | 如何将输出从旧节点映射到新节点 |

## 输入映射

每个输入映射条目定义了输入如何从旧节点传输到新节点。

**从旧输入映射：**
```python
{"new_id": "model", "old_id": "model"}
```

**设置固定值：**
```python
{"new_id": "scheduler", "set_value": "normal"}
```

## 输出映射

输出映射使用基于索引的引用：

```python
{"new_idx": 0, "old_idx": 0}  # 映射第一个输出
{"new_idx": 1, "old_idx": 0}  # 旧输出 0 -> 新输出 1
```

## 小部件 ID 绑定

`old_widget_ids` 字段将小部件 ID 映射到其位置索引。这是必需的，因为工作流 JSON 按位置而不是 ID 存储小部件值。

```python
old_widget_ids=["steps", "cfg", "sampler"]
# 索引 0 处的小部件 = "steps"
# 索引 1 处的小部件 = "cfg"
# 索引 2 处的小部件 = "sampler"
```

## REST API

获取所有已注册的替换：

```
GET /api/node_replacements
```

**响应：**
```json
{
  "OldSamplerNode": [
    {
      "new_node_id": "NewSamplerNode",
      "old_node_id": "OldSamplerNode",
      "old_widget_ids": ["num_steps", "cfg_scale", "sampler_name"],
      "input_mapping": [
        {"new_id": "model", "old_id": "model"},
        {"new_id": "steps", "old_id": "num_steps"},
        {"new_id": "scheduler", "set_value": "normal"}
      ],
      "output_mapping": [
        {"new_idx": 0, "old_idx": 0}
      ]
    }
  ]
}
```

## 使用场景

- **节点迁移**：更新自定义节点包时自动升级用户工作流
- **API 变更**：映射重命名的输入/输出以保持向后兼容性
- **默认值**：为旧节点上不存在的新输入提供合理的默认值
